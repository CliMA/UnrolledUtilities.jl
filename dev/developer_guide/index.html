<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Developer Guide · UnrolledUtilities.jl</title><meta name="title" content="Developer Guide · UnrolledUtilities.jl"/><meta property="og:title" content="Developer Guide · UnrolledUtilities.jl"/><meta property="twitter:title" content="Developer Guide · UnrolledUtilities.jl"/><meta name="description" content="Documentation for UnrolledUtilities.jl."/><meta property="og:description" content="Documentation for UnrolledUtilities.jl."/><meta property="twitter:description" content="Documentation for UnrolledUtilities.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img class="docs-light-only" src="../assets/logo.svg" alt="UnrolledUtilities.jl logo"/><img class="docs-dark-only" src="../assets/logo-dark.svg" alt="UnrolledUtilities.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../introduction/">Introduction</a></li><li><a class="tocitem" href="../user_guide/">User Guide</a></li><li class="is-active"><a class="tocitem" href>Developer Guide</a><ul class="internal"><li><a class="tocitem" href="#How-to-Unroll"><span>How to Unroll</span></a></li><li><a class="tocitem" href="#Interface-API"><span>Interface API</span></a></li><li><a class="tocitem" href="#How-to-Use-the-Interface"><span>How to Use the Interface</span></a></li></ul></li><li><a class="tocitem" href="../comparison_tables/">Comparison Tables</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Developer Guide</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Developer Guide</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/UnrolledUtilities.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/main/docs/src/developer_guide.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h2 id="How-to-Unroll"><a class="docs-heading-anchor" href="#How-to-Unroll">How to Unroll</a><a id="How-to-Unroll-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-Unroll" title="Permalink"></a></h2><p>There are two general ways to implement loop unrolling in Julia—recursively splatting iterator contents and manually constructing unrolled expressions. For example, a recursively unrolled version of the <code>foreach</code> function is</p><pre><code class="language-julia hljs">unrolled_foreach(f, itr) = _unrolled_foreach(f, itr...)
_unrolled_foreach(f) = nothing
_unrolled_foreach(f, item, items...) = (f(item); _unrolled_foreach(f, items...))</code></pre><p>In contrast, a manually unrolled implementation of this function looks like</p><pre><code class="language-julia hljs">unrolled_foreach(f, itr) = _unrolled_foreach(Val(length(itr)), f, itr)
@generated _unrolled_foreach(::Val{N}, f, itr) where {N} =
    Expr(:block, (:(f(generic_getindex(itr, $n))) for n in 1:N)..., nothing)</code></pre><p>Julia&#39;s compiler can only pass up to 32 values through function arguments without allocating heap memory, so recursive unrolling is not type-stable for iterators with lengths greater than 32. However, automatically generating functions often requires more time and memory resources during compilation than writing hard-coded functions. Recursive inlining adds overhead to compilation as well, but this is typically smaller than the overhead of generated functions for short iterators. To avoid sacrificing latency by using generated functions, several hard-coded methods can be added to the manually unrolled implementation:</p><pre><code class="language-julia hljs">_unrolled_foreach(::Val{0}, f, itr) = nothing
_unrolled_foreach(::Val{1}, f, itr) = (f(generic_getindex(itr, 1)); nothing)
_unrolled_foreach(::Val{2}, f, itr) =
    (f(generic_getindex(itr, 1)); f(generic_getindex(itr, 2)); nothing)
_unrolled_foreach(::Val{3}, f, itr) =
    (f(generic_getindex(itr, 1)); f(generic_getindex(itr, 2)); f(generic_getindex(itr, 3)); nothing)</code></pre><p>With this modification, manual unrolling does not exceed the compilation requirements of recursive unrolling across a wide range of use cases. Since it also avoids type instabilities for arbitrarily large iterators, a combination of hard-coded and generated functions with manual unrolling serves as the basis of all unrolled functions defined in this package. Similarly, the <a href="https://github.com/JuliaLang/julia/blob/v1.11.0/base/ntuple.jl"><code>ntuple(f, ::Val{N})</code></a> function in <code>Base</code> uses this strategy to implement loop unrolling.</p><p>For benchmarks that compare these two implementations, see <a href="../comparison_tables/#Manual-vs.-Recursive-Unrolling">Manual vs. Recursive Unrolling</a>.</p><h2 id="Interface-API"><a class="docs-heading-anchor" href="#Interface-API">Interface API</a><a id="Interface-API-1"></a><a class="docs-heading-anchor-permalink" href="#Interface-API" title="Permalink"></a></h2><p>The functions exported by this package can be used with any statically sized iterators, as long as those iterators make appropriate use of the following interface:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UnrolledUtilities.generic_getindex" href="#UnrolledUtilities.generic_getindex"><code>UnrolledUtilities.generic_getindex</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">generic_getindex(itr, n)</code></pre><p>Identical to <code>getindex(itr, n)</code>, but with the added ability to handle lazy iterator types defined in the standard library, such as <code>Base.Generator</code> and <code>Iterators.Enumerate</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/7373be9ff1f66c51c069c3e35165a582701aeb8f/src/unrollable_iterator_interface.jl#L1-L7">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UnrolledUtilities.output_type_for_promotion" href="#UnrolledUtilities.output_type_for_promotion"><code>UnrolledUtilities.output_type_for_promotion</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">output_type_for_promotion(itr)</code></pre><p>The type of output that unrolled functions should try to generate for the input iterator <code>itr</code>, or a <code>ConditionalOutputType</code> if the output type depends on the type of items that need to be stored in it, or <code>NoOutputType()</code> if <code>itr</code> is a lazy iterator without any associated output type. Defaults to <code>Tuple</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/7373be9ff1f66c51c069c3e35165a582701aeb8f/src/unrollable_iterator_interface.jl#L23-L30">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UnrolledUtilities.AmbiguousOutputType" href="#UnrolledUtilities.AmbiguousOutputType"><code>UnrolledUtilities.AmbiguousOutputType</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">AmbiguousOutputType</code></pre><p>The result of <code>output_type_for_promotion</code> for iterators that do not have well-defined output types.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/7373be9ff1f66c51c069c3e35165a582701aeb8f/src/unrollable_iterator_interface.jl#L43-L48">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UnrolledUtilities.NoOutputType" href="#UnrolledUtilities.NoOutputType"><code>UnrolledUtilities.NoOutputType</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">NoOutputType()</code></pre><p>The <code>AmbiguousOutputType</code> of lazy iterators.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/7373be9ff1f66c51c069c3e35165a582701aeb8f/src/unrollable_iterator_interface.jl#L51-L55">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UnrolledUtilities.ConditionalOutputType" href="#UnrolledUtilities.ConditionalOutputType"><code>UnrolledUtilities.ConditionalOutputType</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">ConditionalOutputType(allowed_item_type, output_type, [fallback_type])</code></pre><p>An <code>AmbiguousOutputType</code> that can have one of two possible values. If the first item in the output is a subtype of <code>allowed_item_type</code>, the output will have the type <code>output_type</code>; otherwise, it will have the type <code>fallback_type</code>, which is set to <code>Tuple</code> by default.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/7373be9ff1f66c51c069c3e35165a582701aeb8f/src/unrollable_iterator_interface.jl#L58-L65">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UnrolledUtilities.output_promote_rule" href="#UnrolledUtilities.output_promote_rule"><code>UnrolledUtilities.output_promote_rule</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">output_promote_rule(output_type1, output_type2)</code></pre><p>The type of output that should be generated when two iterators do not have the same <code>output_type_for_promotion</code>, or <code>Union{}</code> if these iterators should not be used together. Only one method of <code>output_promote_rule</code> needs to be defined for any pair of output types.</p><p>By default, all types take precedence over <code>NoOutputType()</code>, and the conditional part of any <code>ConditionalOutputType</code> takes precedence over an unconditional type (so that only the <code>fallback_type</code> of any conditional type gets promoted). The default result for all other pairs of unequal output types is <code>Union{}</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/7373be9ff1f66c51c069c3e35165a582701aeb8f/src/unrollable_iterator_interface.jl#L80-L92">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UnrolledUtilities.constructor_from_tuple" href="#UnrolledUtilities.constructor_from_tuple"><code>UnrolledUtilities.constructor_from_tuple</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">constructor_from_tuple(output_type)</code></pre><p>A function that can be used to efficiently construct an output of type <code>output_type</code> from a <code>Tuple</code>, or <code>identity</code> if such an output should not be constructed from a <code>Tuple</code>. Defaults to <code>identity</code>, which also handles the case where <code>output_type</code> is already <code>Tuple</code>. The <code>output_type</code> here is guaranteed to be a <code>Type</code>, rather than a <code>ConditionalOutputType</code> or <code>NoOutputType</code>.</p><p>Many statically sized iterators (e.g., <code>SVector</code>s) are essentially wrappers for <code>Tuple</code>s, and their constructors for <code>Tuple</code>s can be reduced to no-ops. The main exceptions are <a href="../user_guide/#UnrolledUtilities.StaticOneTo"><code>StaticOneTo</code></a>s and <a href="../user_guide/#UnrolledUtilities.StaticBitVector"><code>StaticBitVector</code></a>s, which do not provide constructors for <code>Tuple</code>s because there is no performance benefit to making a lazy or low-storage data structure once a corresponding high-storage data structure has already been constructed.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/7373be9ff1f66c51c069c3e35165a582701aeb8f/src/unrollable_iterator_interface.jl#L151-L167">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UnrolledUtilities.empty_output" href="#UnrolledUtilities.empty_output"><code>UnrolledUtilities.empty_output</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">empty_output(output_type)</code></pre><p>An empty output of type <code>output_type</code>. Defaults to applying the <code>constructor_from_tuple</code> for the given type to an empty <code>Tuple</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/7373be9ff1f66c51c069c3e35165a582701aeb8f/src/unrollable_iterator_interface.jl#L171-L176">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="UnrolledUtilities.StaticSequence" href="#UnrolledUtilities.StaticSequence"><code>UnrolledUtilities.StaticSequence</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">StaticSequence{N}</code></pre><p>Abstract type that can represent any iterable of constant length <code>N</code>. Subtypes include the low-storage data structures <code>StaticOneTo</code> and <code>StaticBitVector</code>, which have optimized methods for certain unrolled functions.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/UnrolledUtilities.jl/blob/7373be9ff1f66c51c069c3e35165a582701aeb8f/src/UnrolledUtilities.jl#L75-L81">source</a></section></article><h2 id="How-to-Use-the-Interface"><a class="docs-heading-anchor" href="#How-to-Use-the-Interface">How to Use the Interface</a><a id="How-to-Use-the-Interface-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-Use-the-Interface" title="Permalink"></a></h2><p>To unroll over a statically sized iterator of some user-defined type <code>T</code>, follow these steps:</p><ul><li>Add a method for <code>getindex(::T, n)</code>, or for <code>generic_getindex(::T, n)</code> if <code>getindex</code> should not be defined for iterators of type <code>T</code></li><li>If every unrolled function that needs to construct an iterator when given an iterator of type <code>T</code> can return a <code>Tuple</code> instead, stop here</li><li>Otherwise, to return a non-<code>Tuple</code> iterator whenever it is efficient to do so, follow these steps:<ul><li>Add a method for <code>output_type_for_promotion(::T) = O</code>, where <code>O</code> can be <code>T</code>, a supertype of <code>T</code>, some other <code>Type</code>, or an <code>AmbiguousOutputType</code></li><li>If an iterator whose output type is <code>O</code> can be used together with an iterator whose output type is <code>O′</code>, add a method for <code>output_promote_rule(O, O′)</code></li><li>If <code>O</code> is a <code>NoOutputType</code>, stop here</li><li>Otherwise, to handle the unambiguous output type <code>U</code> that underlies <code>O</code> (where <code>U</code> is equivalent to <code>O</code> unless <code>O</code> is a <code>ConditionalOutputType</code>), follow these steps:<ul><li>If an iterator of type <code>U</code> can be efficiently constructed from a <code>Tuple</code>, add a method for <code>constructor_from_tuple(U)</code></li><li>Otherwise, for each of the following functions, add a method if it can be implemented to construct an iterator of type <code>U</code> without first storing the iterator&#39;s contents in a <code>Tuple</code>:<ul><li><code>empty_output(U)</code></li><li><code>unrolled_push_into(U, itr, item)</code></li><li><code>unrolled_append_into(U, itr1, itr2)</code></li><li><code>unrolled_take_into(U, itr, val_N)</code></li><li><code>unrolled_drop_into(U, itr, val_N)</code></li><li><code>unrolled_map_into(U, f, itr)</code></li><li><code>unrolled_accumulate_into(U, op, itr, init, transform)</code></li></ul></li></ul></li></ul></li></ul><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>When a relevant method for the interface is not defined, unrolled functions will typically fall back to using <code>Tuple</code>s instead of other iterator types.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../user_guide/">« User Guide</a><a class="docs-footer-nextpage" href="../comparison_tables/">Comparison Tables »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.9.0 on <span class="colophon-date" title="Tuesday 18 March 2025 22:30">Tuesday 18 March 2025</span>. Using Julia version 1.11.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
